# Ralph Progress Log
# Branch: ralph/item-image-upload
# Started: 2026-01-15

## Codebase Patterns
- Use runtime validation for env vars instead of `!` non-null assertions (ultracite forbids them)
- When creating Supabase clients, always check that NEXT_PUBLIC_SUPABASE_URL and NEXT_PUBLIC_SUPABASE_ANON_KEY exist before using them
- ZodError uses `.issues` (not `.errors`) to access validation error messages
- Server-side Supabase client uses cookies() from next/headers (must be awaited in Next.js 16)
- Biome/ultracite forbids nested ternary expressions - extract to helper functions with if/else
- Dynamic route params in Next.js 16 are a Promise that must be awaited
- Use Number.parseInt(id, 10) with Number.isNaN() for safe ID parsing
- The Item type already has `imageStoragePath: string | null` and `imageUrl: string | null` fields

- react-dropzone useDropzone hook provides getRootProps, getInputProps, isDragActive for easy drag-and-drop implementation
- File selection state should be tracked with useState<File | null> and passed via FormData on submit
- Use Next.js Image component with `unoptimized` prop for blob URLs (local file previews)
- URL.createObjectURL() for local file previews - must be cleaned up with URL.revokeObjectURL() in useEffect cleanup
- Supabase Storage: upload with `supabase.storage.from(bucket).upload(path, file, { upsert: true })`, get URL with `.getPublicUrl(path)`
- Check `formData.get("field") instanceof File && file.size > 0` to detect actual file uploads (empty files have size 0)
- Next.js Image remotePatterns in next.config.ts must include external domains (e.g., *.supabase.co for Supabase Storage)

---

## 2026-01-16 - US-006
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented:
  - ProductCard component already had image display logic in place from prior work
  - Added Supabase Storage domain wildcard (*.supabase.co) to next.config.ts remotePatterns
  - This enables Next.js Image optimization for Supabase-hosted product images
- Files changed:
  - next.config.ts (added Supabase remote pattern for Image component)
- **Learnings for future iterations:**
  - Next.js Image component requires remote domains to be whitelisted in next.config.ts remotePatterns
  - Use wildcard hostname pattern (*.supabase.co) to cover all Supabase project domains
  - Always check next.config.ts when adding new image sources
---

## 2026-01-16 - US-005
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented:
  - Modified createItem server action to handle image file uploads
  - Insert item first with .select("id").single() to get new item ID
  - Upload image to items/{itemId}/{filename} using existing uploadImage helper
  - Update item record with imageStoragePath and imageUrl after upload
  - Added error handling with cleanup (deletes uploaded image if update fails)
- Files changed:
  - app/admin/items/actions.ts (updated createItem to handle image uploads)
- **Learnings for future iterations:**
  - Supabase insert can chain .select() and .single() to return the new record
  - For create flows with file uploads: insert first, get ID, upload, then update with file paths
  - Always clean up uploaded files if subsequent database operations fail
---

## 2026-01-16 - US-004
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented:
  - Added uploadImage() helper to upload files to Supabase Storage
  - Added deleteImage() helper to remove files from storage
  - Modified updateItem server action to handle image FormData
  - Uploads new images to product-images bucket at items/{itemId}/{filename}
  - Deletes old images when replacing or when shouldDelete is true
  - Preserves existing image values when no change is made
  - Uses upsert: true on upload to allow replacing same-named files
- Files changed:
  - app/admin/items/actions.ts (added image upload/delete helpers, updated updateItem)
- **Learnings for future iterations:**
  - Supabase Storage upload uses supabase.storage.from(bucket).upload(path, file, options)
  - getPublicUrl() returns { data: { publicUrl } } - no error property
  - Use Record<string, unknown> for dynamic update objects to avoid type issues
  - Check imageFile instanceof File && imageFile.size > 0 to detect real file uploads
---

## 2026-01-15 - US-003
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented:
  - Added image preview using Next.js Image component (max 200x200, object-contain)
  - Shows existing image from item.imageUrl when editing
  - Added remove button with X icon positioned at top-right corner
  - Implemented three-state image tracking: newFile, existingUrl, shouldDelete
  - When removing: clears newFile, sets shouldDelete=true if existingUrl existed
  - Form submission includes deleteImage flag when shouldDelete is true
- Files changed:
  - components/admin/items/item-form.tsx (added preview, remove button, state management)
- **Learnings for future iterations:**
  - TypeScript narrowing requires direct variable checks (displayImageUrl ? ...) not derived booleans
  - Biome requires Next.js Image instead of <img> - use unoptimized={true} for blob URLs
  - useEffect cleanup returns function to URL.revokeObjectURL() the blob URL
---

## 2026-01-15 - US-002
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented:
  - Installed react-dropzone package
  - Added dropzone component at top of ItemForm (before Name field)
  - Configured for image/* with visual feedback on drag (border/background change)
  - Uses Lucide Upload icon in placeholder
  - Shows selected file name after selection
  - File included in FormData on submit
- Files changed:
  - package.json (added react-dropzone)
  - bun.lock (updated)
  - components/admin/items/item-form.tsx (added dropzone UI and state)
- **Learnings for future iterations:**
  - react-dropzone accept format is { "image/*": [] } for all image types
  - isDragActive boolean triggers visual hover state
  - getRootProps() and getInputProps() wire up the div and hidden input
  - File state must be managed separately and appended to FormData
---

## 2026-01-15 - US-001
Thread: https://ampcode.com/threads/$AMP_CURRENT_THREAD_ID
- What was implemented:
  - Created SQL migration for 'product-images' Supabase Storage bucket
  - Configured bucket with public read access (public: true)
  - Added policies for public SELECT, authenticated INSERT, UPDATE, DELETE
- Files changed:
  - supabase/migrations/20260115184437_create_product_images_bucket.sql (new)
- **Learnings for future iterations:**
  - Supabase Storage buckets are created via INSERT INTO storage.buckets
  - Policies use storage.objects table with bucket_id condition
  - auth.role() = 'authenticated' checks for logged-in users in policies
---

